(function(a){a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{doNotClear:false,expandOnHover:700,isAllowed:function(d,b,c){return true},isTree:false,listType:"ul",maxLevels:2,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,nestedType:"slide",branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf"},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));if(!this.element.is(this.options.listType)){throw new Error("nestedSortable: Please check that the listType option is set to your actual list type")}if(this.options.isTree){this.options.tolerance="intersect"}a.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){var b=this;a(this.items).each(function(){var c=this.item;if(c.children(b.options.listType).length){c.addClass(b.options.branchClass);if(b.options.startCollapsed){c.addClass(b.options.collapsedClass)}else{c.addClass(b.options.expandedClass)}}else{c.addClass(b.options.leafClass)}})}},destroy:function(){this.element.removeData("nestedSortable").unbind(".nestedSortable");return a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(e){var j=this.options;this.position=this._generatePosition(e);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var f=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-e.pageY<j.scrollSensitivity){this.scrollParent[0].scrollTop=f=this.scrollParent[0].scrollTop+j.scrollSpeed}else{if(e.pageY-this.overflowOffset.top<j.scrollSensitivity){this.scrollParent[0].scrollTop=f=this.scrollParent[0].scrollTop-j.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-e.pageX<j.scrollSensitivity){this.scrollParent[0].scrollLeft=f=this.scrollParent[0].scrollLeft+j.scrollSpeed}else{if(e.pageX-this.overflowOffset.left<j.scrollSensitivity){this.scrollParent[0].scrollLeft=f=this.scrollParent[0].scrollLeft-j.scrollSpeed}}}else{if(e.pageY-a(document).scrollTop()<j.scrollSensitivity){f=a(document).scrollTop(a(document).scrollTop()-j.scrollSpeed)}else{if(a(window).height()-(e.pageY-a(document).scrollTop())<j.scrollSensitivity){f=a(document).scrollTop(a(document).scrollTop()+j.scrollSpeed)}}if(e.pageX-a(document).scrollLeft()<j.scrollSensitivity){f=a(document).scrollLeft(a(document).scrollLeft()-j.scrollSpeed)}else{if(a(window).width()-(e.pageX-a(document).scrollLeft())<j.scrollSensitivity){f=a(document).scrollLeft(a(document).scrollLeft()+j.scrollSpeed)}}}if(f!==false&&a.ui.ddmanager&&!j.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,e)}}this.positionAbs=this._convertPositionTo("absolute");var p=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;for(var n=this.items.length-1;n>=0;n--){var r=this.items[n],k=r.item[0],d=this._intersectsWithPointer(r);if(!d){continue}if(k!=this.currentItem[0]&&this.placeholder[d==1?"next":"prev"]()[0]!=k&&!a.contains(this.placeholder[0],k)&&(this.options.type=="semi-dynamic"?!a.contains(this.element[0],k):true)){if(!this.mouseentered){a(k).mouseenter();this.mouseentered=true}if(j.isTree&&a(k).hasClass(j.collapsedClass)&&j.expandOnHover){if(!this.hovering){a(k).addClass(j.hoveringClass);var q=this;this.hovering=window.setTimeout(function(){a(k).removeClass(j.collapsedClass).addClass(j.expandedClass);q.refreshPositions();q._trigger("expand",e,q._uiHash())},j.expandOnHover)}}this.direction=d==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(r)){a(k).mouseleave();this.mouseentered=false;a(k).removeClass(j.hoveringClass);this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;this._rearrange(e,r)}else{break}this._clearEmpty(k);this._trigger("change",e,this._uiHash());break}}var h=(this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length)?a(this.placeholder[0].parentNode.parentNode):null,c=this._getLevel(this.placeholder),l=this._getChildLevels(this.helper);var m=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(m!=null){while(m[0].nodeName.toLowerCase()!="li"||m[0]==this.currentItem[0]||m[0]==this.helper[0]){if(m[0].previousSibling){m=a(m[0].previousSibling)}else{m=null;break}}}var b=this.placeholder[0].nextSibling?a(this.placeholder[0].nextSibling):null;if(b!=null){while(b[0].nodeName.toLowerCase()!="li"||b[0]==this.currentItem[0]||b[0]==this.helper[0]){if(b[0].nextSibling){b=a(b[0].nextSibling)}else{b=null;break}}}var g=document.createElement(j.listType);this.beyondMaxLevels=0;if(h!=null&&b==null&&(j.rtl&&(this.positionAbs.left+this.helper.outerWidth()>h.offset().left+h.outerWidth())||!j.rtl&&(this.positionAbs.left<h.offset().left))){h.after(this.placeholder[0]);if(j.isTree&&h.children(j.listItem).children("li:visible:not(.ui-sortable-helper)").length<1){h.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}this._clearEmpty(h[0]);this._trigger("change",e,this._uiHash())}else{if(m!=null&&!m.hasClass(j.disableNestingClass)&&(m.children(j.listType).length&&m.children(j.listType).is(":visible")||!m.children(j.listType).length)&&(j.rtl&&(this.positionAbs.left+this.helper.outerWidth()<m.offset().left+m.outerWidth()-j.tabSize)||!j.rtl&&(this.positionAbs.left>m.offset().left+j.tabSize))){this._isAllowed(m,c,c+l+1);if(!m.children(j.listType).length){m[0].appendChild(g);j.isTree&&m.removeClass(j.leafClass).addClass(j.branchClass+" "+j.expandedClass)}if(p&&(p<=m.offset().top)){m.children(j.listType).prepend(this.placeholder)}else{m.children(j.listType)[0].appendChild(this.placeholder[0])}this._trigger("change",e,this._uiHash())}else{this._isAllowed(h,c,c+l)}}this._contactContainers(e);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,e)}this._trigger("sort",e,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(b,c){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){a(this.domPosition.prev).after(this.placeholder)}else{a(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",b,this._uiHash())}a("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;a.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(e){var f=this.options.isTree?0.8:0.5;var c=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,e.top+(e.height*f),e.height),h=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,e.top-(e.height*f),e.height),d=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,e.left+(e.width/2),e.width),b=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();if(this.floating&&g){return((g=="right"&&d)||(g=="left"&&!d))}else{return b&&((b=="down"&&c)||(b=="up"&&h))}},_clear:function(d,e){a.ui.sortable.prototype._clear.apply(this,arguments);for(var b=this.items.length-1;b>=0;b--){var c=this.items[b].item[0];this._clearEmpty(c)}},serialize:function(c){var e=a.extend({},this.options,c),b=this._getItemsAsjQuery(e&&e.connected),d=[];a(b).each(function(){var g=(a(e.item||this).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/)),f=(a(e.item||this).parent(e.listType).parent(e.items).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/));if(g){d.push(((e.key||g[1])+"["+(e.key&&e.expression?g[1]:g[2])+"]")+"="+(f?(e.key&&e.expression?f[1]:f[2]):e.rootID))}});if(!d.length&&e.key){d.push(e.key+"=")}return d.join("&")},toHierarchy:function(e){var f=a.extend({},this.options,e),c=f.startDepthCount||0,d=[];a(this.element).children(f.items).each(function(){var g=b(this);d.push(g)});return d;function b(h){var i=(a(h).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/));if(i){var g={id:i[2]};if(a(h).children(f.listType).children(f.items).length>0){g.children=[];a(h).children(f.listType).children(f.items).each(function(){var j=b(this);g.children.push(j)})}return g}}},toArray:function(d){var h=a.extend({},this.options,d),b=h.startDepthCount||0,e=h.slideShowId,c=[],f=2;switch(h.nestedType){case"slide":c.push({slides_id:h.rootID,parent_id:"none",depth:b,lft:"1",rgt:(a(h.items,this.element).length+1)*2,badge:"none",slideshow_id:e});break;case"training":c.push({slideshow_id:h.rootID,parent_id:"none",depth:b,lft:"1",rgt:(a(h.items,this.element).length+1)*2,users:"none",training_id:e});break}a(this.element).children(h.items).each(function(){f=g(this,b+1,f)});c=c.sort(function(j,i){return(j.lft-i.lft)});return c;function g(m,o,n){var l=n+1,p,k,j;if(a(m).children(h.listType).children(h.items).length>0){o++;a(m).children(h.listType).children(h.items).each(function(){l=g(a(this),o,l)});o--}p=(a(m).attr(h.attribute||"id"));switch(h.nestedType){case"slide":j=a(m).find("span.badge.nr").text();break;case"training":j="";break}if(o===b+1){k=h.rootID}else{var i=(a(m).parent(h.listType).parent(h.items).attr(h.attribute||"id"));k=i}if(p){switch(h.nestedType){case"slide":c.push({slides_id:p,parent_id:k,depth:o,lft:n,rgt:l,badge:j,slideshow_id:e});break;case"training":c.push({slideshow_id:p,parent_id:k,depth:o,lft:n,rgt:l,users:j,training_id:e});break}}n=l+1;return n}},_clearEmpty:function(b){var d=this.options;var c=a(b).children(d.listType);if(c.length&&!c.children().length&&!d.doNotClear){d.isTree&&a(b).removeClass(d.branchClass+" "+d.expandedClass).addClass(d.leafClass);c.remove()}else{if(d.isTree&&c.length&&c.children().length&&c.is(":visible")){a(b).removeClass(d.leafClass).addClass(d.branchClass+" "+d.expandedClass)}else{if(d.isTree&&c.length&&c.children().length&&!c.is(":visible")){a(b).removeClass(d.leafClass).addClass(d.branchClass+" "+d.collapsedClass)}}}},_getLevel:function(b){var d=1;if(this.options.listType){var c=b.closest(this.options.listType);while(c&&c.length>0&&!c.is(".ui-sortable")){d++;c=c.parent().closest(this.options.listType)}}return d},_getChildLevels:function(d,f){var c=this,e=this.options,b=0;f=f||0;a(d).children(e.listType).children(e.items).each(function(g,h){b=Math.max(c._getChildLevels(h,f+1),b)});return f?b+1:b},_isAllowed:function(b,g,e){var f=this.options,d=a(this.currentItem[0].parentNode).hasClass("ui-sortable")?true:false,c=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");if(!f.isAllowed(this.placeholder,b,this.currentItem)||f.protectRoot&&(b==null&&!d||d&&g>1)){this.placeholder.addClass(f.errorClass);if(c<e&&c!=0){this.beyondMaxLevels=e-c}else{this.beyondMaxLevels=1}}else{if(c<e&&c!=0){this.placeholder.addClass(f.errorClass);this.beyondMaxLevels=e-c}else{this.placeholder.removeClass(f.errorClass);this.beyondMaxLevels=0}}}}));a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)})(jQuery);